<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Chat RH – Canal de Denúncias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { background: #f5f7fa; font-family: Arial, sans-serif; }
        .card {
            max-width: 520px;
            margin: 64px auto;
            padding: 42px 36px 32px 36px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 24px #00306118;
            position: relative;
        }
        h3 {
            text-align: center;
            color: #1a355e;
            font-size: 1.7rem;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: .01em;
        }
        .info-status {
            margin-bottom: 10px;
            color: #1a355e;
            font-size: 1.07rem;
            padding: 0 0 12px 0;
            border-bottom: 1.5px solid #e4e9f2;
        }
        .status-form-wrap {
            margin-bottom: 16px;
            text-align: left;
        }
        .status-form-wrap form {
            display: flex;
            align-items: center;
        }
        .status-form-wrap label {
            font-weight: bold;
            color: #2a3b4d;
        }
        .status-form-wrap select {
            margin: 0 10px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 1.07rem;
        }
        .status-form-wrap button {
            padding: 7px 18px;
            border-radius: 6px;
            background: linear-gradient(90deg,#49b87a 80%,#38a067 100%);
            color: #fff;
            border: none;
            font-weight: 600;
            margin-left: 7px;
            cursor: pointer;
            font-size: 1.07rem;
        }
        .status-form-wrap button:hover {
            background: linear-gradient(90deg,#38a067 90%,#49b87a 100%);
        }
        .status-sucesso {
            background:#eafbe6;
            color:#268a3f;
            padding:8px 14px;
            border-radius:6px; 
            margin-bottom: 16px;
            font-weight:600;
            font-size:1rem;
            border:1.2px solid #b1efcb;
        }
        .status-denuncia {
            background:#f0f7fe;
            border-radius:12px;
            padding:15px 18px;
            margin-bottom:20px;
            border:1.5px solid #c2dbf7;
        }
        .status-denuncia strong {
            color: #183f80;
            font-size: 1.07em;
        }
        .status-denuncia-texto {
            margin-top:8px;
            color:#20305c;
            font-size:1.08rem;
            line-height: 1.45;
            white-space: pre-line;
        }
        .chat-container {
            background: #f8fafc;
            border: 1.5px solid #e4e9f2;
            border-radius: 14px;
            max-height: 270px;
            overflow-y: auto;
            padding: 18px 15px 8px 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px #6ea8fe1a;
        }
        .chat-msg {
            margin-bottom: 16px;
            padding: 12px 18px 10px 14px;
            border-radius: 14px;
            max-width: 90%;
            min-width: 100px;
            word-break: break-word;
            display: inline-block;
            box-shadow: 0 1px 6px #d4eaff29;
            position: relative;
        }
        .chat-user {
            background: linear-gradient(90deg, #e7f4fd 90%, #d3e6fb 100%);
            color: #125;
            float: right;
            text-align: right;
            margin-left: 10%;
            border-bottom-right-radius: 2px;
        }
        .chat-rh {
            background: linear-gradient(90deg, #e3f9e7 90%, #c2f5d5 100%);
            color: #174821;
            float: left;
            text-align: left;
            margin-right: 10%;
            border-bottom-left-radius: 2px;
        }
        .chat-author {
            font-weight: bold;
            font-size: 1em;
            margin-right: 8px;
        }
        .chat-date {
            font-size: 0.93em;
            color: #86a;
            margin-left: 8px;
            opacity: .85;
        }
        .chat-anexo-link {
            display: inline-block;
            margin: 7px 0 0 0;
            font-size: 0.96em;
            color: #3fa889;
            text-decoration: underline;
        }
        .clearfix::after { content: ""; display: table; clear: both; }
        .chat-form {
            display: flex;
            gap: 11px;
            margin-top: 14px;
            align-items: center;
        }
        .chat-form input[type="text"] {
            flex: 2;
            border-radius: 9px;
            border: 1.2px solid #dbe2ee;
            padding: 11px 12px;
            font-size: 1.02rem;
            outline: none;
            box-shadow: 0 1.5px 7px #eaf3ff1c;
            transition: border .17s;
        }
        .chat-form input[type="text"]:focus {
            border-color: #6ea8fe;
        }
        .input-file-wrap {
            position: relative;
            flex: 1;
            min-width: 100px;
            max-width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .input-file {
            opacity: 0;
            width: 100%;
            height: 41px;
            position: absolute;
            left: 0; top: 0;
            cursor: pointer;
            z-index: 2;
        }
        .label-file {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 41px;
            background: linear-gradient(90deg,#e8f0fa 70%, #dde9f7 100%);
            color: #426187;
            border-radius: 9px;
            padding: 0 4px;
            text-align: center;
            font-weight: 700;
            font-size: 0.97rem;
            box-shadow: 0 2px 8px #6ea8fe0a;
            border: 1px solid #bed8ef;
            cursor: pointer;
            transition: background .17s, box-shadow .19s;
            position: relative;
            z-index: 1;
            white-space: nowrap;
        }
        .label-file span {
            line-height: 1.12;
        }
        .label-file:hover {
            background: #f0f8ff;
            box-shadow: 0 2px 14px #6ea8fe1b;
        }
        .filename {
            font-size: .93rem;
            color: #3770a7;
            margin-top: 4px;
            word-break: break-all;
        }
        .audio-btn {
            background: linear-gradient(90deg,#e7f4fd 90%, #d3e6fb 100%);
            color: #245;
            border: 1.2px solid #a3bde6;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 1.03rem;
            font-weight: bold;
            margin-top: 4px;
            margin-bottom: 0;
            cursor: pointer;
            transition: background .15s;
            margin-left: 0;
        }
        .audio-btn.recording {
            background: #ffe9e9;
            color: #d12a2a;
            border: 1.2px solid #f2b2b2;
        }
        .audio-preview {
            margin-top: 7px;
            max-width: 96%;
        }
        .chat-form button {
            background: linear-gradient(90deg,#49b87a 80%,#38a067 100%);
            color: #fff;
            border: none;
            border-radius: 9px;
            padding: 13px 27px;
            font-weight: 700;
            font-size: 1.09rem;
            cursor: pointer;
            transition: background .2s, box-shadow .2s;
            box-shadow: 0 2px 8px #38a06732;
            min-width: 96px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-form button:hover {
            background: linear-gradient(90deg,#38a067 85%,#49b87a 100%);
            box-shadow: 0 4px 18px #3fa88930;
        }
        .voltar-link {
            display: block;
            margin: 28px auto 0 auto;
            color: #245;
            text-align: center;
            font-size: 1.12rem;
            text-decoration: underline;
        }
        @media (max-width: 700px) {
            .card { padding: 14px 5vw 16px 5vw; }
            h3 { font-size: 1.15rem; }
            .chat-form button { min-width: 72px; padding: 11px 8px;}
            .input-file-wrap { min-width: 80px; max-width: 100px; }
            .label-file { font-size: .90rem; }
        }
    </style>
</head>
<body>
    <div class="card">
        <h3>Chat – Protocolo {{ denuncia.protocolo }}</h3>
        <div class="info-status">
            <b>Status:</b> {{ denuncia.status }}<br>
            <b>Data de envio:</b> {{ denuncia.data_hora.strftime('%d/%m/%Y %H:%M') }}
        </div>
        <div class="status-form-wrap">
            <form method="post" action="{{ url_for('admin_denuncia', protocolo=denuncia.protocolo) }}">
                <label for="novo_status"><b>Status da denúncia:</b></label>
                <select name="novo_status" id="novo_status">
                    <option value="Recebida" {% if denuncia.status == "Recebida" %}selected{% endif %}>Recebida</option>
                    <option value="Em Andamento" {% if denuncia.status == "Em Andamento" %}selected{% endif %}>Em Andamento</option>
                    <option value="Finalizada" {% if denuncia.status == "Finalizada" %}selected{% endif %}>Finalizada</option>
                </select>
                <button type="submit" name="atualizar_status" value="1">Atualizar</button>
            </form>
        </div>
        {% if status_msg %}
            <div class="status-sucesso">{{ status_msg }}</div>
        {% endif %}

        <!-- NOVO BLOCO: Denúncia original -->
        <div class="status-denuncia">
            <strong>Denúncia registrada:</strong>
            <div class="status-denuncia-texto">
                {{ denuncia.texto }}
            </div>
        </div>
        <!-- FIM NOVO BLOCO -->

        <div class="chat-container clearfix">
            {% if mensagens %}
                {% for m in mensagens %}
                    <div class="chat-msg {% if m.autor == 'Usuário' %}chat-user{% else %}chat-rh{% endif %}">
                        <span class="chat-author">{{ m.autor }}:</span>
                        {{ m.texto }}
                        {% if m.anexo %}
                            <br>
                            {% if m.anexo.endswith('.mp3') or m.anexo.endswith('.wav') or m.anexo.endswith('.ogg') or m.anexo.endswith('.m4a') %}
                                <audio controls class="audio-preview">
                                    <source src="{{ url_for('chat_arquivo', filename=m.anexo) }}">
                                    Seu navegador não suporta áudio.
                                </audio>
                            {% elif m.anexo.endswith('.mp4') or m.anexo.endswith('.webm') or m.anexo.endswith('.mov') %}
                                <video controls class="audio-preview" style="border-radius:10px;">
                                    <source src="{{ url_for('chat_arquivo', filename=m.anexo) }}">
                                    Seu navegador não suporta vídeo.
                                </video>
                            {% else %}
                                <a href="{{ url_for('chat_arquivo', filename=m.anexo) }}" target="_blank" class="chat-anexo-link">📎 Anexo</a>
                            {% endif %}
                        {% endif %}
                        <span class="chat-date">{{ m.data_hora.strftime('%d/%m %H:%M') }}</span>
                    </div>
                {% endfor %}
            {% else %}
                <div style="color:#888;text-align:center;">Nenhuma mensagem ainda.</div>
            {% endif %}
            <div class="clearfix"></div>
        </div>
        <!-- CHAT FORM MODERNO -->
        <form method="post" enctype="multipart/form-data" class="chat-form" id="chatFormRh">
            <input type="text" name="mensagem" placeholder="Digite sua mensagem..." maxlength="500" autocomplete="off">
            <div class="input-file-wrap">
                <label for="file-upload-rh" class="label-file">
                    <span>Anexar<br>Documento</span>
                </label>
                <input type="file" id="file-upload-rh" name="anexo" class="input-file"
                    accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.mp3,.wav,.ogg,.mp4,.m4a,.webm,.mov"
                    onchange="showFilenameRh()">
                <div class="filename" id="filename-rh"></div>
                <button type="button" class="audio-btn" id="recBtnRh" onclick="toggleRecordingRh()">🎤 Gravar Áudio</button>
                <audio id="audioPreviewRh" class="audio-preview" style="display:none;" controls></audio>
                <input type="hidden" id="audioDataRh" name="audio_data">
            </div>
            <button type="submit">Enviar</button>
        </form>
        <a href="{{ url_for('admin') }}" class="voltar-link">Voltar para painel</a>
    </div>
    <script>
        // Mostra nome do arquivo
        function showFilenameRh() {
            const input = document.getElementById('file-upload-rh');
            const label = document.getElementById('filename-rh');
            if (input.files.length) {
                label.textContent = input.files[0].name;
            } else {
                label.textContent = '';
            }
        }

        // Gravação de áudio (RH)
        let mediaRecorderRh, audioChunksRh = [];
        function toggleRecordingRh() {
            const recBtn = document.getElementById('recBtnRh');
            const audioPreview = document.getElementById('audioPreviewRh');
            if (!mediaRecorderRh || mediaRecorderRh.state === "inactive") {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaRecorderRh = new MediaRecorder(stream);
                    audioChunksRh = [];
                    mediaRecorderRh.ondataavailable = e => audioChunksRh.push(e.data);
                    mediaRecorderRh.onstop = () => {
                        const audioBlob = new Blob(audioChunksRh, { type: 'audio/webm' });
                        const url = URL.createObjectURL(audioBlob);
                        audioPreview.src = url;
                        audioPreview.style.display = 'block';

                        // Envia para input hidden como base64
                        let reader = new FileReader();
                        reader.onloadend = function() {
                            document.getElementById('audioDataRh').value = reader.result;
                        }
                        reader.readAsDataURL(audioBlob);
                    };
                    mediaRecorderRh.start();
                    recBtn.textContent = "⏹️ Parar Gravação";
                    recBtn.classList.add("recording");
                });
            } else {
                mediaRecorderRh.stop();
                recBtn.textContent = "🎤 Gravar Áudio";
                recBtn.classList.remove("recording");
            }
        }
    </script>
</body>
</html>
