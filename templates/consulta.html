{% extends "base.html" %}
{% block title %}Consulta de Denúncias{% endblock %}

{% block content %}
<div class="container mt-5">
  <h1 class="mb-4">Consulta de Denúncias</h1>

  <!-- Formulário de busca de protocolo -->
  <form method="post" action="{{ url_for('consulta') }}" class="form-inline mb-4">
    <div class="form-group mr-2">
      <input type="text"
             name="protocolo"
             class="form-control"
             placeholder="Digite o protocolo"
             value="{{ protocolo or '' }}"
             required>
    </div>
    <button type="submit" class="btn btn-primary">Buscar</button>
  </form>

  {% if denuncia %}
    <div class="card mb-4">
      <div class="card-header">
        <strong>Protocolo:</strong> {{ denuncia.protocolo }}
      </div>
      <div class="card-body">
        <!-- Exibe conversa -->
        <div class="mb-4" style="max-height: 300px; overflow-y: auto;">
          {% for msg in mensagens %}
            <div class="mb-3">
              <div><strong>{{ msg.autor }}:</strong> <small class="text-muted">{{ msg.data_hora.strftime('%d/%m/%Y %H:%M') }}</small></div>
              {% if msg.texto %}
                <p>{{ msg.texto }}</p>
              {% endif %}
              {% if msg.anexo %}
                <a href="{{ url_for('chat_arquivo', filename=msg.anexo) }}" class="badge badge-info" target="_blank">Download do arquivo</a>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <!-- Formulário de resposta/chat -->
        <form method="post"
              action="{{ url_for('chat', protocolo=denuncia.protocolo) }}"
              enctype="multipart/form-data"
              autocomplete="off">

          <div class="form-group">
            <input type="text"
                   name="mensagem"
                   class="form-control"
                   placeholder="Digite sua mensagem..."
                   maxlength="500"
                   required>
          </div>

          <div class="form-row align-items-center mb-3">
            <div class="col-auto">
              <label class="btn btn-secondary mb-0">
                Anexar Documento
                <input type="file"
                       name="anexo"
                       class="d-none"
                       accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.xls,.xlsx">
              </label>
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-secondary" onclick="abrirGravadorAudio()">Gravar Áudio</button>
            </div>
          </div>

          <button type="submit" class="btn btn-success">Enviar</button>
        </form>
      </div>
    </div>
  {% endif %}
</div>

<script>
function abrirGravadorAudio() {
  alert("Funcionalidade de gravação de áudio ainda não implementada.");
}
</script>
{% endblock %}
